<?php

declare(strict_types=1);

namespace App\Service;

use App\DTO\CreatePropositionDTO;
use App\DTO\RespondPropositionDTO;
use App\Entity\Proposition;
use App\Entity\User;
use App\Repository\DemandeRepository;
use App\Repository\PropositionRepository;
use App\Repository\VoyageRepository;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

readonly class PropositionService
{
    public function __construct(
        private EntityManagerInterface $entityManager,
        private PropositionRepository $propositionRepository,
        private VoyageRepository $voyageRepository,
        private DemandeRepository $demandeRepository,
        private NotificationService $notificationService,
        private CurrencyService $currencyService,
    ) {}

    /**
     * Cr√©er une proposition pour un voyage
     */
    public function createProposition(int $voyageId, CreatePropositionDTO $dto, User $client): Proposition
    {
        // V√©rifier que le voyage existe
        $voyage = $this->voyageRepository->find($voyageId);
        if (!$voyage) {
            throw new NotFoundHttpException('Voyage non trouv√©');
        }

        // V√©rifier que la demande existe
        $demande = $this->demandeRepository->find($dto->demandeId);
        if (!$demande) {
            throw new NotFoundHttpException('Demande non trouv√©e');
        }

        // V√©rifier que le client est bien le propri√©taire de la demande
        if ($demande->getClient() !== $client) {
            throw new BadRequestHttpException('Vous ne pouvez faire une proposition qu\'avec votre propre demande');
        }

        // V√©rifier que le client ne propose pas sur son propre voyage
        if ($voyage->getVoyageur() === $client) {
            throw new BadRequestHttpException('Vous ne pouvez pas faire de proposition sur votre propre voyage');
        }

        // V√©rifier que le voyage est actif
        if ($voyage->getStatut() !== 'actif') {
            throw new BadRequestHttpException('Ce voyage n\'est plus actif');
        }

        // V√©rifier que la demande est en recherche
        if ($demande->getStatut() !== 'en_recherche') {
            throw new BadRequestHttpException('Cette demande n\'est plus en recherche');
        }

        // V√©rifier qu'une proposition n'existe pas d√©j√†
        $existingProposition = $this->propositionRepository->existsByVoyageAndDemande($voyageId, $dto->demandeId);
        if ($existingProposition) {
            throw new BadRequestHttpException('Vous avez d√©j√† fait une proposition pour ce voyage');
        }

        if (($voyage->getPoidsDisponible() - $demande->getPoidsEstime()) <= 0) {
            throw new BadRequestHttpException('Le voyage n\'a plus de place disponible');
        }

        // ==================== DEVISE DE LA DEMANDE ====================
        // La proposition utilise TOUJOURS la devise de la demande du client
        $currency = $demande->getCurrency();

        // Cr√©er la proposition
        $proposition = new Proposition();
        $proposition->setVoyage($voyage)
            ->setDemande($demande)
            ->setClient($client)
            ->setVoyageur($voyage->getVoyageur())
            ->setPrixParKilo((string) $dto->prixParKilo)
            ->setCommissionProposeePourUnBagage((string) $dto->commissionProposeePourUnBagage)
            ->setCurrency($currency) // ‚¨ÖÔ∏è Toujours la devise de la demande
            ->setMessage($dto->message)
            ->setStatut('en_attente');

        $this->entityManager->persist($proposition);
        $this->entityManager->flush();

        // Notifier le voyageur
        $this->notificationService->createNotification(
            $voyage->getVoyageur(),
            'new_proposition',
            'Nouvelle proposition re√ßue',
            sprintf(
                '%s %s a fait une proposition pour votre voyage %s vers %s',
                $client->getPrenom(),
                $client->getNom(),
                $voyage->getVilleDepart(),
                $voyage->getVilleArrivee()
            ),
            [
                'propositionId' => $proposition->getId(),
                'voyageId' => $voyage->getId()
            ]
        );

        return $proposition;
    }

    /**
     * R√©pondre √† une proposition (accepter/refuser)
     */
    public function respondToProposition(int $propositionId, RespondPropositionDTO $dto, User $voyageur): Proposition
    {
        /** @var Proposition|null $proposition */
        $proposition = $this->propositionRepository->find($propositionId);

        if (!$proposition) {
            throw new NotFoundHttpException('Proposition non trouv√©e');
        }

        // V√©rifier que c'est bien le voyageur concern√©
        if ($proposition->getVoyageur() !== $voyageur) {
            throw new BadRequestHttpException('Vous n\'√™tes pas autoris√© √† r√©pondre √† cette proposition');
        }

        // V√©rifier que la proposition est en attente
        if ($proposition->getStatut() !== 'en_attente') {
            throw new BadRequestHttpException('Cette proposition a d√©j√† re√ßu une r√©ponse');
        }

        $voyage = $proposition->getVoyage();
        $demande = $proposition->getDemande();

        if ($dto->action === 'accepter') {
            // ‚úÖ 1. Accepter la proposition actuelle
            $proposition->setStatut('acceptee');
            $proposition->setReponduAt(new \DateTimeImmutable());

            // ‚öôÔ∏è Conversion DECIMAL ‚Üí float
            $poidsDisponible = (float) $voyage->getPoidsDisponibleRestant();
            $poidsDemande = (float) $demande->getPoidsEstime();

            // üí° Calcul et pr√©vention des valeurs n√©gatives
            $newVoyagePoids = max(0, $poidsDisponible - $poidsDemande);
            $voyage->setPoidsDisponibleRestant(number_format($newVoyagePoids, 2, '.', ''));

            // üß© Marquer le voyage comme complet si plus de place
            if ($newVoyagePoids == 0.0) {
                $voyage->setStatut('complete');
            }

            // ‚úÖ 2. Marquer la demande comme satisfaite
            $demande->setStatut('voyageur_trouve');

            // üîÅ 3. Annuler toutes les autres propositions de cette m√™me demande
            foreach ($demande->getPropositions() as $autreProposition) {
                if ($autreProposition->getId() !== $proposition->getId() && $autreProposition->getStatut() === 'en_attente') {
                    $autreProposition->setStatut('annulee');
                    $autreProposition->setReponduAt(new \DateTimeImmutable());

                    // üîî Notifier le voyageur concern√©
                    $this->notificationService->createNotification(
                        $autreProposition->getVoyageur(),
                        'proposition_annulee',
                        'Proposition annul√©e',
                        sprintf(
                            'La demande de %s %s a d√©j√† trouv√© un voyageur pour le voyage %s vers %s. Votre proposition a √©t√© automatiquement annul√©e.',
                            $demande->getClient()->getPrenom(),
                            $demande->getClient()->getNom(),
                            $autreProposition->getVoyage()->getVilleDepart(),
                            $autreProposition->getVoyage()->getVilleArrivee()
                        ),
                        [
                            'propositionId' => $autreProposition->getId(),
                            'demandeId' => $demande->getId(),
                        ]
                    );
                }
            }

            // üîî 4. Notifier le client dont la proposition a √©t√© accept√©e
            $this->notificationService->createNotification(
                $proposition->getClient(),
                'proposition_acceptee',
                'Proposition accept√©e',
                sprintf(
                    '%s %s a accept√© votre proposition pour le voyage %s vers %s.',
                    $voyageur->getPrenom(),
                    $voyageur->getNom(),
                    $voyage->getVilleDepart(),
                    $voyage->getVilleArrivee()
                ),
                [
                    'propositionId' => $proposition->getId(),
                    'voyageId' => $voyage->getId(),
                ]
            );

        } else {
            // ‚ùå Refus
            $proposition->setStatut('refusee');
            $proposition->setMessageRefus($dto->messageRefus);
            $proposition->setReponduAt(new \DateTimeImmutable());

            // üîî Notifier le client
            $this->notificationService->createNotification(
                $proposition->getClient(),
                'proposition_refusee',
                'Proposition refus√©e',
                sprintf(
                    '%s %s a refus√© votre proposition pour le voyage %s vers %s.',
                    $voyageur->getPrenom(),
                    $voyageur->getNom(),
                    $voyage->getVilleDepart(),
                    $voyage->getVilleArrivee()
                ),
                [
                    'propositionId' => $proposition->getId(),
                    'voyageId' => $voyage->getId(),
                ]
            );
        }

        $this->entityManager->flush();

        return $proposition;
    }

    /**
     * R√©cup√©rer les propositions pour un voyage
     */
    public function getPropositionsByVoyage(int $voyageId): array
    {
        return $this->propositionRepository->findByVoyage($voyageId);
    }

    /**
     * R√©cup√©rer les propositions accept√©es pour un voyage
     */
    public function getAcceptedPropositionsByVoyage(int $voyageId): array
    {
        return $this->propositionRepository->findAcceptedByVoyage($voyageId);
    }

    /**
     * R√©cup√©rer les propositions faites par un client
     */
    public function getPropositionsByClient(int $clientId): array
    {
        return $this->propositionRepository->findByClient($clientId);
    }

    /**
     * R√©cup√©rer les propositions re√ßues par un voyageur
     */
    public function getPropositionsByVoyageur(int $voyageurId): array
    {
        return $this->propositionRepository->findByVoyageur($voyageurId);
    }

    /**
     * Compter les propositions en attente pour un voyageur
     */
    public function countPendingByVoyageur(int $voyageurId): int
    {
        return $this->propositionRepository->countPendingByVoyageur($voyageurId);
    }

    /**
     * Convertir les montants d'une proposition dans une devise cible
     */
    public function convertPropositionAmounts(Proposition $proposition, string $targetCurrency): array
    {
        $result = [
            'originalCurrency' => $proposition->getCurrency(),
            'targetCurrency' => $targetCurrency,
        ];

        $result['prixParKilo'] = $this->currencyService->convert(
            (float) $proposition->getPrixParKilo(),
            $proposition->getCurrency(),
            $targetCurrency
        );
        $result['prixParKiloFormatted'] = $this->currencyService->formatAmount(
            $result['prixParKilo'],
            $targetCurrency
        );

        $result['commission'] = $this->currencyService->convert(
            (float) $proposition->getCommissionProposeePourUnBagage(),
            $proposition->getCurrency(),
            $targetCurrency
        );
        $result['commissionFormatted'] = $this->currencyService->formatAmount(
            $result['commission'],
            $targetCurrency
        );

        return $result;
    }

    /**
     * Obtenir le r√©capitulatif d'une proposition avec conversion
     * Utile pour afficher au voyageur les montants dans sa devise
     */
    public function getPropositionSummaryWithConversion(Proposition $proposition, User $viewer): array
    {
        $viewerCurrency = $viewer->getSettings()?->getDevise()
            ?? $this->currencyService->getDefaultCurrency();

        $summary = [
            'id' => $proposition->getId(),
            'statut' => $proposition->getStatut(),
            'message' => $proposition->getMessage(),
            'messageRefus' => $proposition->getMessageRefus(),
            'createdAt' => $proposition->getCreatedAt(),

            // ==================== CLIENT ====================
            'client' => [
                'id' => $proposition->getClient()->getId(),
                'nom' => $proposition->getClient()->getNom(),
                'prenom' => $proposition->getClient()->getPrenom(),
            ],

            // ==================== VOYAGEUR ====================
            'voyageur' => [
                'id' => $proposition->getVoyage()->getVoyageur()->getId(),
                'nom' => $proposition->getVoyage()->getVoyageur()->getNom(),
                'prenom' => $proposition->getVoyage()->getVoyageur()->getPrenom(),
            ],

            // ==================== DEMANDE ====================
            'demande' => [
                'id' => $proposition->getDemande()->getId(),
                'villeDepart' => $proposition->getDemande()->getVilleDepart(),
                'villeArrivee' => $proposition->getDemande()->getVilleArrivee(),
                'poidsEstime' => $proposition->getDemande()->getPoidsEstime()
            ],

            // ==================== VOYAGE ====================
            'voyage' => [
                'id' => $proposition->getVoyage()->getId(),
                'villeDepart' => $proposition->getVoyage()->getVilleDepart(),
                'villeArrivee' => $proposition->getVoyage()->getVilleArrivee(),
                'dateDepart' => $proposition->getVoyage()->getDateDepart(),
            ],

            // ==================== MONTANTS √Ä PLAT (compatible CurrencyDisplay) ====================
            'prixParKilo' => (float) $proposition->getPrixParKilo(),
            'commissionProposeePourUnBagage' => (float) $proposition->getCommissionProposeePourUnBagage(),
            'currency' => $proposition->getCurrency(),
            'viewerCurrency' => $viewerCurrency,
        ];

        // ==================== CONVERSION SI N√âCESSAIRE ====================
        if ($proposition->getCurrency() !== $viewerCurrency) {
            $converted = $this->convertPropositionAmounts($proposition, $viewerCurrency);
            $summary['converted'] = [
                'originalCurrency' => $proposition->getCurrency(),
                'targetCurrency' => $viewerCurrency,
                'prixParKilo' => $converted['prixParKilo'],
                'prixParKiloFormatted' => $converted['prixParKiloFormatted'],
                'commission' => $converted['commission'],
                'commissionFormatted' => $converted['commissionFormatted'],
            ];
        }

        return $summary;
    }
}
